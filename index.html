<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rompecabezas por niveles</title>
<style>
    body {
        margin:0;
        font-family: Arial, sans-serif;
        background:#111;
        color:white;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        height:100vh;
        overflow:hidden;
    }

    #pantalla-carga {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        background:black;
        color:white;
        display:flex;
        justify-content:center;
        align-items:center;
        z-index:10;
        font-size:2em;
        transition: opacity 1s;
    }

    #canvas {
        border:2px solid white;
        cursor:pointer;
        margin-top:20px;
    }

    #botones {
        display:none;
        margin-top:20px;
    }

    button {
        padding:10px 20px;
        background:#333;
        color:white;
        border:none;
        cursor:pointer;
        font-size:16px;
    }
    button:hover { background:#555; }

    /* ====== ESTILO PARA EL INPUT ====== */
    #upload {
        padding:15px 25px;
        background:#444;
        border:2px dashed #888;
        cursor:pointer;
        font-size:18px;
        color:white;
        border-radius:10px;
        margin-bottom:20px;
        text-align:center;
    }

    #upload:hover {
        background:#555;
        border-color:white;
    }

</style>
</head>
<body>

<div id="pantalla-carga">Cargando próximo juego...</div>

<!-- BOTÓN DE INSERTAR IMAGEN -->
<label id="upload-label">
    <input type="file" id="upload" accept="image/*">
    Inserte imagen aquí.
</label>

<canvas id="canvas"></canvas>

<div id="botones">
    <button id="nivel-btn">Siguiente nivel</button>
</div>

<script>
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let upload = document.getElementById("upload");
let nivelBtn = document.getElementById("nivel-btn");

let img = new Image();
let piezas = [];
let size = 4;     
let piezaSize = 0;
let dragIndex = null;

setTimeout(() => {
    document.getElementById("pantalla-carga").style.opacity = 0;
    setTimeout(() => document.getElementById("pantalla-carga").style.display="none", 1000);
}, 2000);

upload.addEventListener("change", e => {
    let file = e.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = ev => {
        img.onload = iniciarJuego;
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
});

function iniciarJuego() {
    canvas.width = img.width;
    canvas.height = img.height;
    piezaSize = canvas.width / size;

    document.getElementById("upload-label").style.display = "none";

    generarPiezas();
    canvas.addEventListener("click", clickPieza);
    dibujar();
}

function generarPiezas() {
    piezas = [];
    for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
            piezas.push({
                xOriginal: x,
                yOriginal: y,
                x: x,
                y: y
            });
        }
    }
    piezas.sort(() => Math.random() - 0.5);
}

function dibujar() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for (let p of piezas) {
        ctx.drawImage(
            img,
            p.xOriginal * piezaSize, p.yOriginal * piezaSize,
            piezaSize, piezaSize,
            p.x * piezaSize, p.y * piezaSize,
            piezaSize, piezaSize
        );
    }
}

function clickPieza(ev) {
    let x = Math.floor(ev.offsetX / piezaSize);
    let y = Math.floor(ev.offsetY / piezaSize);

    let index = piezas.findIndex(p => p.x === x && p.y === y);

    if (dragIndex === null) {
        dragIndex = index;
    } else {
        let temp = { x: piezas[dragIndex].x, y: piezas[dragIndex].y };
        piezas[dragIndex].x = piezas[index].x;
        piezas[dragIndex].y = piezas[index].y;
        piezas[index].x = temp.x;
        piezas[index].y = temp.y;

        dragIndex = null;
        dibujar();
        comprobar();
    }
}

function comprobar() {
    let correcto = piezas.every(p => p.x === p.xOriginal && p.y === p.yOriginal);
    if (correcto) document.getElementById("botones").style.display="block";
}

nivelBtn.addEventListener("click", () => subdividir());

function subdividir() {
    piezaSize = piezaSize / 4;
    let nuevas = [];
    
    for (let p of piezas) {
        for (let y = 0; y < 4; y++) {
            for (let x = 0; x < 4; x++) {
                nuevas.push({
                    xOriginal: p.xOriginal * 4 + x,
                    yOriginal: p.yOriginal * 4 + y,
                    x: p.x * 4 + x,
                    y: p.y * 4 + y
                });
            }
        }
    }
    piezas = nuevas.sort(() => Math.random() - 0.5);
    document.getElementById("botones").style.display="none";
    dibujar();
}
</script>

</body>
</html>
